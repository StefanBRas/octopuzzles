<script lang="ts">
  import { formatDistanceToNowStrict } from 'date-fns';
  import Button from '$ui/Button.svelte';
  import Trash from 'phosphor-svelte/lib/Trash/Trash.svelte';
  import NotePencil from 'phosphor-svelte/lib/NotePencil/NotePencil.svelte';
  import LoadingIndicator from '$ui/LoadingIndicator.svelte';
  import type { Sudoku } from '$models/Sudoku';
  import type { User } from '$models/User';
  import type { Label } from '$models/Label';
  import PuzzleLabel from '$ui/PuzzleLabel.svelte';
  import SudokuDisplay from './Display/SudokuDisplay.svelte';
  import {
    defaultBorderclues,
    defaultCages,
    defaultCellclues,
    defaultCells,
    defaultEditorColors,
    defaultGivens,
    defaultLogic,
    defaultPaths,
    defaultRegions
  } from '$utils/defaults';

  export let sudokus:
    | (Sudoku & { user?: Pick<User, 'id' | 'username' | 'role'>; labels: Label[] })[]
    | null;
  export let hasNextPage: boolean;
  export let loading: boolean;
  export let loadNextPage: () => Promise<void>;
  export let deleteSudoku: ((id: number) => void) | undefined = undefined;
</script>

{#if !sudokus && loading}
  <div class="w-full flex justify-center mt-4">
    <LoadingIndicator class="w-40 h-40 text-orange-500" />
  </div>
{/if}
{#if sudokus}
  <div
    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 3xl:grid-cols-5 gap-8 p-4"
  >
    {#each sudokus as sudoku (sudoku.id)}
      {#if sudoku}
        <a
          class="shadow-md items-center col-span-1 flex flex-col border rounded-md overflow-hidden cursor-pointer"
          href="/sudoku/{sudoku.id}"
          data-sveltekit-preload-data
        >
          <div class="h-96 w-full p-4 justify-center">
            <SudokuDisplay
              sudoku={{
                borderclues: sudoku.borderclues ?? defaultBorderclues(),
                cellclues: sudoku.cellclues ?? defaultCellclues(),
                cells: sudoku.cells ?? defaultCells(sudoku.dimensions),
                colors: sudoku.colors ?? defaultEditorColors(sudoku.dimensions),
                dimensions: sudoku.dimensions,
                extendedcages: sudoku.extendedcages ?? defaultCages(),
                givens: sudoku.givens ?? defaultGivens(sudoku.dimensions),
                logic: sudoku.logic ?? defaultLogic(),
                paths: sudoku.paths ?? defaultPaths(),
                regions: sudoku.regions ?? defaultRegions(sudoku.dimensions)
              }}
            />
          </div>
          <div class="h-32 bg-gray-100 w-full border-t p-2">
            <div class="flex justify-between h-20">
              <div class="flex flex-col justify-around">
                <h2 class="text-gray-700 text-lg max-w-xs font-medium truncate">
                  {sudoku.title ?? '[untitled]'}
                </h2>
                <div class="flex text-sm text-gray-500">
                  {#if sudoku.user}
                    <a class="cursor-pointer hover:text-gray-800" href={`/user/${sudoku.user.id}`}>
                      {sudoku.user.username}
                    </a>
                  {:else}
                    <p class="text-sm text-gray-500">[deleted]</p>
                  {/if}
                  <span class="mx-1">•</span>
                  <p class="">
                    {sudoku.points ?? 0} point{Math.abs(sudoku.points) !== 1 ? 's' : ''}
                  </p>
                  <span class="mx-1">•</span>
                  {#if sudoku.publicSince}
                    <p>{formatDistanceToNowStrict(sudoku.publicSince)} ago</p>
                  {:else}
                    <p class="text-orange-500">Not public</p>
                  {/if}
                </div>
              </div>
              {#if deleteSudoku}
                <div class="flex flex-col items-end justify-around">
                  <a
                    class="rounded-full w-7 h-7 p-1 hover:bg-gray-200"
                    href="/sudoku/editor?id={sudoku.id}"><NotePencil size={20} /></a
                  >
                  <button
                    class="rounded-full w-7 h-7 p-1 hover:text-red-500 hover:bg-red-100"
                    on:click|preventDefault={() => deleteSudoku?.(sudoku.id)}
                  >
                    <Trash size={20} />
                  </button>
                </div>
              {/if}
            </div>

            <div class="h-8 w-full flex items-center overflow-y-hidden overflow-x-auto">
              {#if sudoku.labels}
                <div class="flex gap-2">
                  {#each sudoku.labels as label}
                    <PuzzleLabel {label} />
                  {/each}
                </div>
              {/if}
            </div>
          </div>
        </a>
      {/if}
    {/each}
  </div>

  <div class="flex justify-center my-4">
    {#if hasNextPage}
      <Button variant="secondary" {loading} on:click={() => loadNextPage()}>Load more</Button>
    {/if}
  </div>
{/if}
